# 🎵 音乐理论游戏化学习平台 - 开发标准书

## 📋 目录

1. [项目概述](#1-项目概述)
2. [技术架构](#2-技术架构)
3. [代码规范](#3-代码规范)
4. [文件结构](#4-文件结构)
5. [组件设计](#5-组件设计)
6. [状态管理](#6-状态管理)
7. [音频处理](#7-音频处理)
8. [测试标准](#8-测试标准)
9. [性能要求](#9-性能要求)
10. [部署规范](#10-部署规范)
11. [文档要求](#11-文档要求)
12. [版本控制](#12-版本控制)

---

## 1. 项目概述

### 1.1 项目目标
- **愿景**: 将乐理学习做成"好玩、可视化、可坚持"的互动游戏
- **目标用户**: 音乐零基础/初学者，自学乐器人群，K12音乐课堂
- **成功标准**: 次周留存 ≥ 35%，平均学习时长 ≥ 12分钟，完成首条学习路径 ≥ 60%

### 1.2 技术选型
- **前端框架**: React 18 + TypeScript 5
- **构建工具**: Vite 5
- **音频引擎**: Tone.js 14
- **状态管理**: Zustand (计划)
- **UI框架**: Tailwind CSS + Radix UI (计划)
- **测试框架**: Jest + React Testing Library
- **部署平台**: Vercel/Netlify

---

## 2. 技术架构

### 2.1 整体架构
```
┌─────────────────────────────────────────┐
│                前端层                    │
├─────────────────────────────────────────┤
│  React Components │ Audio Engine │ UI   │
├─────────────────────────────────────────┤
│           状态管理层 (Zustand)            │
├─────────────────────────────────────────┤
│        业务逻辑层 (Hooks/Utils)          │
├─────────────────────────────────────────┤
│        数据层 (LocalStorage/API)         │
└─────────────────────────────────────────┘
```

### 2.2 模块划分
- **Core**: 核心业务逻辑
- **Audio**: 音频处理引擎
- **UI**: 用户界面组件
- **Game**: 游戏逻辑
- **Utils**: 工具函数
- **Types**: 类型定义

---

## 3. 代码规范

### 3.1 TypeScript 规范

#### 3.1.1 类型定义
```typescript
// ✅ 推荐：使用 interface 定义对象结构
interface GameState {
  score: number;
  level: number;
  isPlaying: boolean;
}

// ✅ 推荐：使用 type 定义联合类型
type GameMode = 'memory' | 'matching' | 'rhythm';

// ✅ 推荐：使用 enum 定义常量
enum NoteType {
  WHOLE = 'whole',
  HALF = 'half',
  QUARTER = 'quarter',
  EIGHTH = 'eighth'
}
```

#### 3.1.2 函数定义
```typescript
// ✅ 推荐：明确的参数和返回值类型
const calculateScore = (correct: number, total: number): number => {
  return Math.round((correct / total) * 100);
};

// ✅ 推荐：使用泛型
const createGameState = <T>(initialState: T): GameState<T> => {
  // ...
};
```

### 3.2 React 组件规范

#### 3.2.1 组件结构
```typescript
// ✅ 推荐：函数组件 + TypeScript
interface NoteCardProps {
  note: string;
  solfege: string;
  isRevealed: boolean;
  onClick: (note: string) => void;
}

const NoteCard: React.FC<NoteCardProps> = ({
  note,
  solfege,
  isRevealed,
  onClick
}) => {
  // 1. Hooks
  const [isAnimating, setIsAnimating] = useState(false);
  
  // 2. 事件处理函数
  const handleClick = useCallback(() => {
    onClick(note);
    setIsAnimating(true);
  }, [note, onClick]);
  
  // 3. 副作用
  useEffect(() => {
    // ...
  }, []);
  
  // 4. 渲染
  return (
    <div className="note-card" onClick={handleClick}>
      {/* JSX */}
    </div>
  );
};

export default NoteCard;
```

#### 3.2.2 命名规范
- **组件名**: PascalCase (如: `NoteGame`, `AudioEngine`)
- **文件名**: PascalCase (如: `NoteGame.tsx`)
- **Hook名**: camelCase，以 `use` 开头 (如: `useAudioEngine`)
- **常量**: UPPER_SNAKE_CASE (如: `NOTE_DATA`, `GAME_CONFIG`)

### 3.3 代码风格

#### 3.3.1 格式化规则
```typescript
// ✅ 推荐：使用 Prettier 配置
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 80,
  "tabWidth": 2,
  "useTabs": false
}
```

#### 3.3.2 注释规范
```typescript
/**
 * 计算音符匹配得分
 * @param correct 正确答案数量
 * @param total 总题目数量
 * @param timeBonus 时间奖励系数
 * @returns 最终得分
 */
const calculateScore = (
  correct: number,
  total: number,
  timeBonus: number = 1
): number => {
  const baseScore = (correct / total) * 100;
  return Math.round(baseScore * timeBonus);
};
```

---

## 4. 文件结构

### 4.1 目录结构
```
src/
├── components/           # 可复用组件
│   ├── ui/              # 基础UI组件
│   ├── game/            # 游戏相关组件
│   └── audio/           # 音频相关组件
├── hooks/               # 自定义Hooks
├── stores/              # 状态管理
├── utils/               # 工具函数
├── types/               # 类型定义
├── constants/           # 常量定义
├── assets/              # 静态资源
│   ├── audio/           # 音频文件
│   ├── images/          # 图片资源
│   └── data/            # 数据文件
├── pages/               # 页面组件
├── services/            # API服务
└── styles/              # 样式文件
```

### 4.2 文件命名规范
- **组件文件**: `ComponentName.tsx`
- **Hook文件**: `useHookName.ts`
- **工具文件**: `utilityName.ts`
- **类型文件**: `types.ts` 或 `ComponentName.types.ts`
- **常量文件**: `constants.ts` 或 `CONSTANT_NAME.ts`

---

## 5. 组件设计

### 5.1 组件分类

#### 5.1.1 基础组件 (UI Components)
```typescript
// 基础按钮组件
interface ButtonProps {
  variant: 'primary' | 'secondary' | 'danger';
  size: 'small' | 'medium' | 'large';
  disabled?: boolean;
  children: React.ReactNode;
  onClick?: () => void;
}

const Button: React.FC<ButtonProps> = ({
  variant,
  size,
  disabled,
  children,
  onClick
}) => {
  // 实现
};
```

#### 5.1.2 业务组件 (Business Components)
```typescript
// 游戏组件
interface GameProps {
  mode: GameMode;
  difficulty: Difficulty;
  onComplete: (score: number) => void;
}

const Game: React.FC<GameProps> = ({ mode, difficulty, onComplete }) => {
  // 实现
};
```

### 5.2 组件设计原则
1. **单一职责**: 每个组件只负责一个功能
2. **可复用性**: 通过props控制组件行为
3. **可测试性**: 组件逻辑清晰，易于测试
4. **性能优化**: 合理使用memo、useMemo、useCallback

---

## 6. 状态管理

### 6.1 状态管理策略
```typescript
// 使用 Zustand 进行状态管理
interface GameStore {
  // 状态
  currentGame: GameState | null;
  userProgress: UserProgress;
  audioSettings: AudioSettings;
  
  // 操作
  startGame: (mode: GameMode) => void;
  updateScore: (score: number) => void;
  completeGame: () => void;
  updateAudioSettings: (settings: Partial<AudioSettings>) => void;
}

const useGameStore = create<GameStore>((set, get) => ({
  // 实现
}));
```

### 6.2 状态管理原则
1. **最小化状态**: 只存储必要的状态
2. **状态归一化**: 避免重复数据
3. **不可变性**: 使用不可变更新
4. **类型安全**: 完整的TypeScript类型

---

## 7. 音频处理

### 7.1 音频引擎规范
```typescript
// 音频引擎接口
interface AudioEngine {
  // 初始化
  initialize: () => Promise<void>;
  
  // 音符播放
  playNote: (note: string, duration?: string) => void;
  playSequence: (notes: string[], interval?: number) => void;
  
  // 节拍器
  startMetronome: (bpm: number) => void;
  stopMetronome: () => void;
  
  // 音效
  playEffect: (type: EffectType) => void;
  
  // 清理
  dispose: () => void;
}
```

### 7.2 音频处理原则
1. **资源管理**: 及时释放音频资源
2. **错误处理**: 优雅处理音频初始化失败
3. **性能优化**: 预加载常用音频资源
4. **用户体验**: 提供音频开关选项

---

## 8. 测试标准

### 8.1 测试策略
```typescript
// 单元测试示例
describe('NoteGame', () => {
  it('should render note cards correctly', () => {
    render(<NoteGame />);
    expect(screen.getByText('C')).toBeInTheDocument();
  });
  
  it('should handle card click events', () => {
    const mockOnClick = jest.fn();
    render(<NoteCard note="C" onClick={mockOnClick} />);
    fireEvent.click(screen.getByText('C'));
    expect(mockOnClick).toHaveBeenCalledWith('C');
  });
});
```

### 8.2 测试覆盖率要求
- **单元测试**: ≥ 80%
- **集成测试**: 核心业务流程
- **E2E测试**: 关键用户路径

---

## 9. 性能要求

### 9.1 性能指标
- **首屏加载时间**: < 2.5s
- **交互响应时间**: < 100ms
- **音频延迟**: < 5ms
- **内存使用**: < 100MB

### 9.2 优化策略
1. **代码分割**: 使用动态导入
2. **资源优化**: 图片压缩，音频压缩
3. **缓存策略**: 合理使用浏览器缓存
4. **懒加载**: 非关键资源延迟加载

---

## 10. 部署规范

### 10.1 环境配置
```typescript
// 环境变量配置
interface EnvConfig {
  NODE_ENV: 'development' | 'production' | 'test';
  VITE_API_URL: string;
  VITE_AUDIO_CDN: string;
  VITE_ANALYTICS_ID?: string;
}
```

### 10.2 部署流程
1. **代码检查**: ESLint + TypeScript 检查
2. **测试运行**: 单元测试 + 集成测试
3. **构建优化**: 生产环境构建
4. **部署验证**: 功能测试 + 性能测试

---

## 11. 文档要求

### 11.1 代码文档
- **README**: 项目介绍和快速开始
- **API文档**: 组件和函数说明
- **变更日志**: 版本更新记录

### 11.2 开发文档
- **架构设计**: 系统架构说明
- **开发指南**: 新开发者入门
- **部署指南**: 部署流程说明

---

## 12. 版本控制

### 12.1 Git 规范
```bash
# 分支命名
feature/note-game-memory
bugfix/audio-delay-issue
hotfix/critical-audio-bug

# 提交信息格式
feat: add memory card game component
fix: resolve audio initialization issue
docs: update development standards
```

### 12.2 版本管理
- **主版本**: 重大功能更新
- **次版本**: 新功能添加
- **修订版本**: 问题修复

---

## 📝 附录

### A. 开发工具配置
- **VS Code**: 推荐插件列表
- **ESLint**: 代码检查规则
- **Prettier**: 代码格式化配置
- **Husky**: Git hooks 配置

### B. 常用命令
```bash
# 开发
npm run dev

# 构建
npm run build

# 测试
npm run test

# 代码检查
npm run lint

# 格式化
npm run format
```

### C. 参考资源
- [React 官方文档](https://react.dev/)
- [TypeScript 手册](https://www.typescriptlang.org/docs/)
- [Tone.js 文档](https://tonejs.github.io/)
- [Vite 指南](https://vitejs.dev/guide/)

---

**文档版本**: v1.0  
**最后更新**: 2024年  
**维护者**: 开发团队  

> 本开发标准书是项目开发的重要指导文档，所有开发者都应严格遵守。如有疑问或建议，请及时反馈。
